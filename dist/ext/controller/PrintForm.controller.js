sap.ui.define(["sap/ui/core/mvc/ControllerExtension"],function(t){"use strict";let e="";let n=[];var r=(new Date).getUTCFullYear()+""+((new Date).getUTCMonth()+1)+""+(new Date).getUTCDate()+"_"+(new Date).getUTCHours()+""+(new Date).getUTCMinutes()+""+(new Date).getUTCSeconds();var a=new Date;var o="Ngày "+String(a.getDate()).padStart(2,"0")+" tháng "+String(a.getMonth()+1).padStart(2,"0")+" năm "+a.getFullYear();var i=[];var c=[];var s=10;return t.extend("ns1.zfi1002v3.ext.controller.PrintForm",{override:{onInit:function(){var t=this.base.getExtensionAPI().getModel()}},nestArrays:async function(t,e){const n={};e.forEach(t=>{const e=t.AccountingDocument;if(!n[e]){n[e]=[]}n[e].push(t)});const r=t.map(t=>({HeaderItems:t,LineItems:n[t.AccountingDocument]||[]}));return r},printForm:async function(){let t="";i=[];c=[];let e=[];var r=this.getView().getModel();t=this.base.getExtensionAPI().getSelectedContexts();var a=r.bindList("/GLVoucherItems");let o=t.map(t=>t.requestObject().then(async t=>{e.push(t.AccountingDocument);i.push(t)}));Promise.all(o).then(async()=>{const t=await this.filterLineByHeader(e,a);c=t;n=await this.nestArrays(i,c);console.log("Data mapping header line",n);let r=await this.pagebreak(n);console.log("Data break",r);let o="";for(let t=0;t<r.length;t++){o+=await this.templateHtml(r[t],t+1,r.length)}setTimeout(()=>this.print(o,true),3e3)}).catch(t=>{console.error("Error retrieving context data:",t)})},pagebreak(t){const e=t.flatMap(t=>{if(t.LineItems.length>s){const e=[];const n=t.LineItems;for(let r=0;r<n.length;r+=s){const a=n.slice(r,r+s);e.push({...t,LineItems:a})}return e}return[t]});console.log("breakData",e);return e},filterLineByHeader:function(t,e){let n=[];let r=[];t.forEach(t=>{n.push(new sap.ui.model.Filter("AccountingDocument",sap.ui.model.FilterOperator.EQ,t))});let a=new sap.ui.model.Filter(n);return e.filter(a).requestContexts().then(t=>{t.forEach(t=>{r.push(t.getObject())});return r})},print:function(t,e){sap.ui.getCore().attachInit(function(){html2pdf().set({filename:"demo_"+r+".pdf",margin:[5,5,5,5],jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{after:".page-break"}}).from(t).outputPdf().get("pdf").then(function(t){if(e){window.open(t.output("bloburl"),"F")}})})},templateHtml:async function(t,n,r){this._sValidPath=sap.ui.require.toUrl("ns1/zfi1002v3/template/accountingVoucher.html");e="";var a=t.HeaderItems;var i=t.LineItems;var c=[];var s=[];var u={};for(let e=0;e<i.length;e++){var t=i[e];u={STT:e+1,DEC:t.DocumentItemText,BANK:t.GLAccount,DEBIT:parseFloat(t.DebitAmount),CREDIT:parseFloat(t.CreditAmount),CUR:t.CompanyCodeCurrency,ACCOUNT:t.Supplier};s.push(u)}var l="Ngày "+String(new Date(a.DocumentDate).getDate()).padStart(2,"0")+" tháng "+String(new Date(a.DocumentDate).getMonth()+1).padStart(2,"0")+" năm "+new Date(a.DocumentDate).getFullYear();var m=sap.ui.require.toUrl("ns1/zfi1002v3/images/logo.jpg");var g={image:m,TODAY:o,CompanyName:"TDI APJ Vietnam Co., Ltd.",Address:"Bình Thạnh",Date:l,CerType:a.AccountingDocumentType,CerNum:a.AccountingDocument,RefNum:a.OriginalReferenceDocument,NumVote:a.AccountingDocument,Status:a.DocumentStatus,Note:a.ReversalReason,PageNo:n+"/"+r,ExRate:a.TransactionCurrency,MoneyType:a.TransactionCurrency,PRTD:s.map(t=>e=`\n\t\t\t\t\t<tr>\n\t\t\t\t\t${Object.values(t).map(t=>`<td style="border-bottom: 1px solid #ccc; padding:8px">${t}</td>`).join("")}\n\t\t\t\t\t</tr>\n\t\t\t\t`).join(""),SUMDEBIT:this.formatMoney(s.map(t=>t.DEBIT).reduce((t,e)=>t+e),a.TransactionCurrency),SUMCREDIT:this.formatMoney(s.map(t=>t.CREDIT).reduce((t,e)=>t+e),a.TransactionCurrency)};await $.get(this._sValidPath,function(t){e=t;var n=Object.entries(g);n.forEach(t=>{var n="##"+t[0]+"##";var r=new RegExp(n,"g");e=e.replace(r,t[1])})},"html").fail(function(t,e,n){console.error("Error:",textStatus,n)});return e},formatMoney(t,e){return new Intl.NumberFormat("de-DE",{style:"currency",currency:e,currencyDisplay:"code"}).format(t).replace(e,"").trim()},formatDate(t){var e=new Date(t);var n=e.getFullYear();var r=e.getMonth()+1;var a=e.getDate();return String(a).padStart(2,"0")+"/"+String(r).padStart(2,"0")+"/"+n}})});
//# sourceMappingURL=PrintForm.controller.js.map